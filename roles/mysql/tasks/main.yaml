  - name: Install MySQL Server package
    apt:
      name: mysql-server
      state: present
    become: yes
    tags: mysql

  - name: Ensure MySQL service is started and enabled
    service:
      name: mysql
      state: started
      enabled: yes
  
  
  - name: Install PyMySQL package
    apt:
      name: python3-pymysql
      state: present

  - name: Create override.cnf file
    template:
      src: mysql_override.cnf.j2
      dest: /etc/mysql/mysql.conf.d/override.cnf
      owner: mysql
      group: mysql
    notify: Restart Mysql
    

  - name: MySQL database
    community.mysql.mysql_db:
      name: "{{ mysql_database }}"
      login_unix_socket: /var/run/mysqld/mysqld.sock

  
  - name: MySQL user
    community.mysql.mysql_user:
      name: "{{ mysql_user }}"
      password: "{{ mysql_password }}"
      host: "%"
      priv: "{{ mysql_database }}.*:ALL"
      login_unix_socket: /var/run/mysqld/mysqld.sock
  
  - name: Include Exporter Tasks
    include_tasks: exporters/main.yaml

  - name: Ensure mysql service is started and enabled
    service:
      name: mysql
      state: started
      enabled: yes
  
#########BACKUP##########

  - name: Ensure /home/backup/mysql directory exists
    file:
      path: /home/backup/mysql
      state: directory
      owner: backup
      group: backup
      mode: '0755'
  
  - name: Create MySQL user 'backup' with privileges
    mysql_user:
      name: "{{ mysql_backup_user }}"
      password: "{{ mysql_backup_pass }}"
      priv: "agama.*:LOCK TABLES,SELECT"
      login_unix_socket: /var/run/mysqld/mysqld.sock
      state: present
  
  - name: Create MySQL client configuration file for user 'backup'
    template:
      src: backup.my.cnf.j2
      dest: /home/backup/.my.cnf
      mode: '0644'
  
  - name: Create Cron file 
    template:
      src: mysql_backup_cron.j2
      dest: /etc/cron.d/mysql-backup
      mode: '0644'
    notify: Restart Mysql




